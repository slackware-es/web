<!DOCTYPE html>
<html lang="en-US">
  <head>
    


  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: 'unsafe-inline' 'unsafe-eval'; font-src 'self' https: data:; img-src 'self' https: data:; object-src 'none'">


    <meta name="generator" content="Hugo 0.53" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disk usage | Slackware</title>
    <meta name="description" content="Analyzing disk usage in Slackware.">
    <meta name="keywords" content="slackbook">
    
    
    
    
    <meta property="og:title" content="Disk usage" />
<meta property="og:description" content="Analyzing disk usage in Slackware." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://slackware.es/posts/diskusage/" /><meta property="article:published_time" content="2018-08-04T08:01:21&#43;00:00"/>
<meta property="article:modified_time" content="2018-08-04T08:01:21&#43;00:00"/>

    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://slackware.es/img/penguins.jpg"/>

<meta name="twitter:title" content="Disk usage"/>
<meta name="twitter:description" content="Analyzing disk usage in Slackware."/>

    



  <meta property="og:image" content="https://slackware.es/img/penguins.jpg">


    

    
    
  <meta name="referrer" content="same-origin">


    
    
    <script integrity="sha512-Jx/MqTxYWqHdoOkHItRJJZCvFDhERPr5gG4I5ESu3V&#43;BgQyAQ6wXfdsGzhzmT0yyvkAWz2jbrn81q90RRJTSTg==">/*! Fetch Inject v2.0.2 | Copyright (C) 2017–2018 Josh Habdas <jhabdas@protonmail.com> | @license Zlib */
var fetchInject=function(){"use strict";const e=function(e,t,r,n,o,c,i){c=t.createElement(r),i=t.getElementsByTagName(r)[0],c.appendChild(t.createTextNode(n.text)),c.onload=o(n),i?i.parentNode.insertBefore(c,i):t.head.appendChild(c)};return function(t,r){if(!arguments.length)return Promise.reject(new ReferenceError("Failed to execute 'fetchInject': 1 argument required but only 0 present."));if(arguments[0]&&arguments[0].constructor!==Array)return Promise.reject(new TypeError("Failed to execute 'fetchInject': argument 1 must be of type 'Array'."));if(arguments[1]&&arguments[1].constructor!==Promise)return Promise.reject(new TypeError("Failed to execute 'fetchInject': argument 2 must be of type 'Promise'."));const n=[],o=r?[].concat(r):[],c=[];return t.forEach(e=>o.push(window.fetch(e).then(e=>[e.clone().text(),e.blob()]).then(e=>Promise.all(e).then(e=>{n.push({text:e[0],blob:e[1]})})))),Promise.all(o).then(()=>(n.forEach(t=>{c.push({then:r=>{t.blob.type.includes("text/css")?e(window,document,"style",t,r):e(window,document,"script",t,r)}})}),Promise.all(c)))}}();
</script>
    <script integrity="sha512-hno7WeTIciCJSjg/myjyK30HYkrcGCVwo4g4SpUalvrs3r2lS7bPNIQwbCNypKbg7BZ1sA4AsGnk6Gq4NOKpGA==">fetchInject(["/js/lazysizes.min.js"]);
</script>
    


  
    

  <meta title="mod:fractal-forest" content="status:enabled">
  
    <script async src=/js/bpgdec8a.js integrity=sha384-8PG0go3BW8hLm63KbTxk/hNcehaoSbrAhKzsmy2Jhs/KY8QdiKKkjhdeyHY/Q/0I&#10;></script>
  


  
  
  
  


    
    <link rel="canonical" href="https://slackware.es/posts/diskusage/">
    
    
    <link rel="icon" sizes="any" href="data:image/svg+xml,%3Csvg%20viewBox='0%200%2046%2045'%20xmlns='http://www.w3.org/2000/svg'%3E%3Ctitle%3EAfter%20Dark%3C/title%3E%3Cpath%20d='M.708%2045L23%20.416%2045.292%2045H.708zM35%2038L23%2019%2011%2038h24z'%20fill='%23000'/%3E%3C/svg%3E">

    

  
    
      <style>:root {
	--fg: #272822;
	--bg: #fbf9f1;
}

@font-face {
	font-family: 'Terminus';
	src: url('/fonts/terminus/TerminusTTF-4.46.0.ttf');
	font-style: normal;
}

@font-face {
	font-family: 'Terminus';
	src: url('/fonts/terminus/TerminusTTF-Bold-4.46.0.ttf');
	font-weight: bold;
}

@font-face {
	font-family: 'Terminus';
	src: url('/fonts/terminus/TerminusTTF-Italic-4.46.0.ttf');
	font-style: italic;
}

@font-face {
	font-family: 'Bitter';
	src: url('/fonts/bitter/Bitter-Regular.ttf');
	font-style: normal;
}

@font-face {
	font-family: 'Bitter';
	src: url('/fonts/bitter/Bitter-Bold.ttf');
	font-weight: bold;
}

@font-face {
	font-family: 'Bitter';
	src: url('/fonts/bitter/Bitter-Italic.ttf');
	font-style: italic;
}

body, html {
	height: 100%;
}

/* baisc typography */

html, body, section, nav, article, aside, h1, h2, h3, h4, h5, h6, hgroup, header, footer, address, p, hr, pre, blackquote, ol, ul, li, dl, dt, dd, figure, figcaption, div, table, caption, form, fieldset {
	vertical-align: baseline;
	margin 0;
	padding 0;
}

body {
	font-family: 'Bitter', serif;
	line-height: 1.5;
	font-size: 1.15rem;
	font-kerning: normal;
	font-variant-numeric: oldstyle-nums proportional-nums;
	font-variant-ligatures: common-ligatures contextual;
	font-feature-settings: "kern", "liga", "clig", "calt";
	background-color: var(--bg);
	color: var(--fg);
}


p {
	text-align: justify;
	-webkit-hyphens: auto;
	-webkit-hyphenate-limit-before: 4;
	-webkit-hyphenate-limit-after: 3;
	-webkit-hyphenate-limit-chars: 7 4 3;
	-webkit-hyphenate-limit-lines: 2;
	-webkit-hyphenate-limit-zone: 8%;
	-webkit-hyphenate-limit-last: always;
	-moz-hyphens: auto;
	-moz-hyphenate-limit-chars: 7 4 3;
	-moz-hyphenate-limit-lines: 2;
	-moz-hyphenate-limit-zone: 8%;
	-moz-hyphenate-limit-last: always;
	-ms-hyphens: auto;
	-ms-hyphenate-limit-chars: 7 4 3;
	-ms-hyphenate-limit-lines: 2;
	-ms-hyphenate-limit-zone: 8%;
	-ms-hyphenate-limit-last: always;
	hyphens: auto;
	hyphenate-limit-chars: 7 4 3;
	hyphenate-limit-lines: 2;
	hyphenate-limit-zone: 8%;
	hyphenate-limit-last: always;
	margin-bottom: 0;
	letter-spacing: -0.01em;
}

p + p {
	text-indent: 2em;
	margin-top: 0;
}

.quoted p {
	quotes: '“' '”' '‘' '’';
}

.quoted p::before {
	content: open-quote;
	margin-left: -0.83ch;
}
.quoted p::after {
	content: close-quote;
}


ol {
	padding-left: 0; margin-left: 0;list-style: none;
	counter-reset: list;
}

ol li::before {
	counter-increment: list;
	content: counter(list);
	margin-left: -2em; margin-right: 1em;
}

h1 {font-family: 'Terminus', fixed;  font-size: 2.0625rem; line-height: 1;}
h2 {font-family: 'Terminus', fixed; font-size: 1.5625rem; line-height: 1;}
h3 {font-family: 'Terminus', fixed; font-size: 1.3125rem; line-height: 1;}
h4 {font-family: 'Terminus', fixed; font-size: 1.2025rem; line-height: 1.2;}
h5 {font-family: 'Terminus', fixed; font-size: 1.2025rem; line-height: 1.2;}
h6 {font-family: 'Terminus', fixed; font-size: 1.2025rem; line-height: 1.2;}
p {font-size: 1.15rem;}

@media screen and(min-width: 60em) {
	h1 {font-family: 'Terminus', fixed;  font-size: 3.1875rem; line-height: 1;}
	h2 {font-family: 'Terminus', fixed; font-size: 2.0625rem; line-height: 1;}
	h3 {font-family: 'Terminus', fixed; font-size: 1.5625rem; line-height: 1;}
	h4 {font-family: 'Terminus', fixed; font-size: 1.325rem; line-height: 1.2;}
	h5 {font-family: 'Terminus', fixed; font-size: 1.325rem; line-height: 1.2;}
	h6 {font-family: 'Terminus', fixed; font-size: 1.325rem; line-height: 1.2;}	
	p {font-size: 1.225rem;}
}

@media screen and(min-width: 120em) {
	h1 {font-family: 'Terminus', fixed;  font-size: 4.875rem; line-height: 1;}
	h2 {font-family: 'Terminus', fixed; font-size: 2.75rem; line-height: 1;}
	h3 {font-family: 'Terminus', fixed; font-size: 1.75rem; line-height: 1;}
	h4 {font-family: 'Terminus', fixed; font-size: 1.5125rem; line-height: 1.2;}
	h5 {font-family: 'Terminus', fixed; font-size: 1.5125rem; line-height: 1.2;}	
	h6 {font-family: 'Terminus', fixed; font-size: 1.5125rem; line-height: 1.2;}
	p {font-size: 1.4125rem;}
}

pre, code {
	font-family: 'Terminus', fixed;
	font-weight: regular;
	line-height: 1.2;
	font-kerning: normal;
	font-variant-numeric: oldstyle-nums proportional-nums;
	font-variant-ligatures: common-ligatures contextual;
	font-feature-settings: "kern", "liga", "clig", "calt";
}

pre:hover,
pre:focus {
  width: min-content;
}

a:hover, a:active, a:focus {
	background-color: var(--bg);
	color: rgb(231, 25, 1);
	border-bottom: 1px solid rgba(0,0,0,0.6);
}

a, .toggle__input + label {
	color: inherit;
	text-decoration: none;
	border-bottom: 1px solid rgba(0,0,0,0.2);
	transition: all 0.25s ease;
}

div.center {
	overflow: hidden;
}

div.center iframe{
	overflow: hidden;
	scrolling: no;	
	display: block;
	margin-left: auto;
	margin-right: auto;
	width: 750px;
	height: 390px;
}

table {
	color: var(--fg);
}

:target {
	color: rgb(231, 25, 1);
}

img {
	max-width: 100%;
	max-height: 100%;
}


.hero-image {
	/* Use "linear-gradient" to add a darken background effect to the image (photographer.jpg). This will make the text easier to read 
	background-image: linear-gradient(rgba(251, 249, 241, 0.3), rgba(251, 249, 241, 0.4)), url("/img/penguins.jpg"); */

	/* Set a specific height 
	height: 6em;*/

	/* Position and center the image to scale nicely on all screens */
	background-position: center center;
	background-repeat: no-repeat;
	background-size: cover;
	width: 100%;
}

/* Place text in the middle of the image */
.hero-text {
	text-align: center;
	line-height: 2;
}

.hero-text h1 {
	font-family: Terminus, fixed;
	font-size: 5rem;
	font-weigth: bold;
	padding: 1rem;
	margin-top: 2rem;
	margin-bottom: 1rem;
}

.hero-text h2 {
	font-family: Bitter, serif;
	font-size: 2rem;
	font-weigth: bold;
}

.getButton {
	width: 20rem;
	font-family: Terminus, fixed;
	font-size: 1.5rem;
	font-weigth: bold;
	background-color: var(--fg);
	color: var(--bg);
	padding: 5px;
}

.highlight {
	background-color: var(--fg);
	color: var(--bg);
}

.changelog {
	font-family: Terminus, fixed;
	font-weigth: regular;
	padding: 0;
}

/* forms */

.form-group {
	margin-bottom: 1.75rem;
	overflow: auto;
}

fieldset {
	border: none;
	padding: 0;
	margin: 0;
}

input.form-control {
	font-size: initial;
	border-radius: 0;
	background-color: transparent;
	-webkit-appearance: none;
	-moz-appearance: none;
	-ms-appearance: none;
}

.form-control {
	outline: none;
	border: none;
	border-bottom: 2px solid #ccc;
	padding: .5rem 0;
	width: 20rem;
	height: 38px;
	background-color: transparent;
}

/* responsiveness */
body {
	width: 50rem;
	max-width: 80%;
	margin: 0 auto;
	padding: 2rem 1rem;
}

img {
	max-width: 100%;
	height: auto;
}

@media \0screen {
  img { 
  	width: auto; /* for ie 8 */
  }
}

.grid {
	display: grid;
}

.cell {
	overflow-x: auto;
}

.two {
	grid-template-columns: repeat(auto-fill, minmax(200px, 1fr); 
}

.three {
	grid-template-columns: 1fr 1fr 1fr;
}

pre {
    white-space: pre-wrap;       /* Since CSS 2.1 */
    white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
    white-space: -pre-wrap;      /* Opera 4-6 */
    white-space: -o-pre-wrap;    /* Opera 7 */
    word-wrap: break-word;       /* Internet Explorer 5.5+ */
}
</style>
      


  


    
  


    
    
      <script integrity="sha512-ISTAV0GadOIz/NXXHOS+eCM0ysXVVHhQTlvA6LJxz/DeA5yIxm0Vqf5IE+WH0yuuXkayAKtoZkQ326nch5f/fg==">fetchInject(["/css/syntax.css"]);</script>
      <noscript>
        <link href="/css/syntax.css" rel="stylesheet">
      </noscript>
    
  </head>
  
  
  
  <body class="">
    <header>
  

  
    
      
  <nav itemscope itemtype="https://schema.org/SiteNavigationElement">
    <meta itemprop="name" content="Main Menu">
    
      
      
        <a itemprop="url" href="/">Home</a>
      
    
      
      
        <a itemprop="url" href="/posts/">Blog</a>
      
    
      
      
        <a itemprop="url" href="/docs/">Docs</a>
      
    
      
      
        <a itemprop="url" href="/files/">Downloads</a>
      
    
      
      
        <a itemprop="url" href="/search/">Search</a>
      
    
  </nav>


    
  


</header>
    <main>
  <article itemscope itemtype="https://schema.org/BlogPosting">
    
<meta itemprop="name" content="Disk usage">
<meta itemprop="description" content="Analyzing disk usage in Slackware.">


<meta itemprop="datePublished" content="2018-08-04T08:01:21&#43;00:00" />
<meta itemprop="dateModified" content="2018-08-04T08:01:21&#43;00:00" />
<meta itemprop="wordCount" content="1715">



<meta itemprop="keywords" content="slackbook," />

    <header>
      <h1 itemprop="headline name">Disk usage</h1>
      <p class="muted">
        <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
  <circle cx="16" cy="16" r="14" />
  <path d="M16 8 L16 16 20 20" />
</svg>
<span>9 minute read</span>
<svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
  <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z" />
</svg>

  Published: <time datetime="2018-08-04T08:01:21&#43;00:00">4 Aug, 2018</time>


      </p>
      
        <blockquote itemprop="description">Analyzing disk usage in Slackware.</blockquote>
      
      
    </header>
    
  <details>
    <summary>Table of Contents</summary>
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#useful-tools">Useful tools</a></li>
<li><a href="#filesystem-usage">Filesystem usage</a></li>
<li><a href="#identify-system-files">Identify system files</a>
<ul>
<li>
<ul>
<li><a href="#disk-usage-by-installed-packages">Disk usage by installed packages</a></li>
<li><a href="#identify-orphan-files">Identify orphan files</a></li>
</ul></li>
</ul></li>
<li><a href="#delete-unwanted-files">Delete unwanted files</a></li>
</ul></li>
</ul>
</nav>
  </details>


    <div itemprop="articleBody">
      <p>In this post we will explore how to free disk space without reinstalling the system, and will present some scripts to help in the process.</p>

<h2 id="introduction">Introduction</h2>

<p>After some time using your system, installing new software and trying out settings, it&rsquo;s inevitable to find that the disk usage is growing.</p>

<p>It could be a daunting process to free disk space, and most people will reinstall the systems again, adding to the new installation the experience got with the old one.</p>

<p>It&rsquo;s common to think the in the new system, this problem will go away because you&rsquo;ve learned a lot, and the system space will remain low, while only your data will increase. But on my experience, most people install again the operating system to clean it out.</p>

<p>A new installed Slackware, using the recommended installation process, installs aournd 10GB of software in your computer. But poking around and trying out software, can get you to 40GB in no time.</p>

<p>Our strategy to clean up the system will be:</p>

<ul>
<li>check the filesystem to see where is used the space</li>
<li>check temporary files</li>
<li>check installed packages and see how much space the use</li>
<li>check files which do not belong to any package</li>
</ul>

<h2 id="useful-tools">Useful tools</h2>

<p>There are multiple tools to get information about filesystem usage, for example:</p>

<ul>
<li><a href="http://xdiskusage.sourceforge.net/">xdiskusage</a></li>
</ul>











<figure class="lazyload">
  
    
      <img class="lazyload" data-src="/img/xdiskusage_layout.png" alt="xdiskusage analisys of /" />
    
  
  
  <figcaption>
    
    <small>xdiskusage analisys of /
    
      
    
    </small>
  </figcaption>
  
</figure>


<ul>
<li><a href="https://dev.yorhel.nl/ncdu">ncdu</a></li>
</ul>

<div class="center">
	<iframe src="/scr/ncdu_root_stats.xhtml" frameborder="0">
		
 ncdu showing / disk usage statistics
 
	</iframe>
</div>


<p>But sometimes we need to understand the problem to be able to use those tools correctly. Also if you make our own tools we will be able to automate certain tasks.</p>

<h2 id="filesystem-usage">Filesystem usage</h2>

<p>The <code>du</code> utility, which stands for disk usage, can give you the size of a file or a folder.</p>

<p>With no arguments <code>du</code> will print the size of all files and folders from the current folder. And with the options <code>-s</code> and <code>-h</code> will summarize and print information of the current folder converting the size from Kb to the biggest unite possible (Mb, Gb, etc.)</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gdiazlo@darkstar:~$ du -sh
<span style="color:#ae81ff">9</span>.4G    .
gdiazlo@darkstar:~$ </code></pre></div>

<p>It also accepts a parameter to show which folder is the starting point to calculate sizes:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gdiazlo@darkstar:~$ du -sh $HOME
<span style="color:#ae81ff">9</span>.4G    .
gdiazlo@darkstar:~$ </code></pre></div>

<p>So knowing where is the space going, it might tempt us to do</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gdiazlo@darkstar:~$ du -sh /*</code></pre></div>

<p>but be aware: <code>du</code> will try to calculate the size of all mounted filesystems, including CD-ROMs, network shares, and synthetic filesystems like <code>/proc</code>. That will slow the process or even show errors.</p>

<p>A solution found in <a href="https://superuser.com/questions/638982/du-x-still-examines-mounted-filesystems-when-using-wildcard">superuser.com</a> site works well on a system with multiple mounted filesystems.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:~# <span style="color:#66d9ef">for</span> a in /*; <span style="color:#66d9ef">do</span> mountpoint -q -- <span style="color:#e6db74">&#34;</span>$a<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">||</span> du -s -h -x <span style="color:#e6db74">&#34;</span>$a<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">done</span>
13M     /bin
35M     /boot
31M     /etc
<span style="color:#ae81ff">9</span>.4G    /home
559M    /lib
27M     /lib64
16K     /lost+found
64K     /media
56K     /mnt
212M    /opt
<span style="color:#ae81ff">1</span>.9G    /root
24M     /sbin
<span style="color:#ae81ff">4</span>.0K    /srv
<span style="color:#ae81ff">4</span>.9G    /tmp
16G     /usr
<span style="color:#ae81ff">4</span>.9G    /var
root@darkstar:~# </code></pre></div>

<p>We can see in the list the top 5 space users:</p>

<ul>
<li><code>/usr</code> uses 16G of space</li>
<li><code>/home</code> uses 9.5G of space</li>
<li><code>/var</code> uses 4.9G of space</li>
<li><code>/tmp</code> uses 4.9G of space</li>
<li><code>/root</code> uses 1.9G of space</li>
</ul>

<p>All that combined is 37.2G of space.</p>

<p>The space used in <code>/usr</code> and <code>/var</code> should correspond to files from the operating system: installed software, packages, logs, databases, and together they account for 20.9G of space.</p>

<p>The space used in <code>/tmp</code> should be disposable as it only serves the purpose to contain ephemeral information.</p>

<p>And the <code>/root</code><code>and</code><code>/home</code>` contain personal files from the administrator and the users of the computer.</p>

<p>With this information we state a different strategy to each case:</p>

<ul>
<li>system files: check packages and files that do not belong to any installed package</li>
<li>temporary files: delete them if possible</li>
<li>administrator and user files: check the downloads and temporary files, delete on your discretion</li>
</ul>

<h2 id="identify-system-files">Identify system files</h2>

<p>We read about <a href="/docs/packages/">package managemt in Slackware</a> to devise an strategy to:</p>

<ul>
<li>calculate the space used by installed packages</li>
<li>identify orphan files (not related to any package) and their disk usage</li>
</ul>

<h4 id="disk-usage-by-installed-packages">Disk usage by installed packages</h4>

<p>We analize the space each packae uses throught its metadata files stored in <code>/var/log/packages</code>.</p>

<p>To show the packages ordered by its uncompressed size in ascending order:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">for</span> p in <span style="color:#e6db74">`</span>ls -1 /var/log/packages<span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
        head -n <span style="color:#ae81ff">3</span> /var/log/packages/$p | awk  <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">/PACKAGE NAME:/ { name=$3 }
</span><span style="color:#e6db74">/UNCOMPRESSED PACKAGE SIZE:/ { size=$4 }
</span><span style="color:#e6db74">END{
</span><span style="color:#e6db74">        print size, &#34; &#34; , name
</span><span style="color:#e6db74">}&#39;</span>
<span style="color:#66d9ef">done</span> | numfmt --from<span style="color:#f92672">=</span>si | sort -n -k <span style="color:#ae81ff">1</span> | numfmt --to<span style="color:#f92672">=</span>si</code></pre></div>

<p>The script is not very fast, but produce good results:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:~# ./pkgsize-meta | tail -n <span style="color:#ae81ff">10</span>
168M   emacs-26.1-x86_64-1
176M   seamonkey-2.49.4-x86_64-1
220M   kernel-modules-4.14.60-x86_64-1
285M   mariadb-10.3.8-x86_64-1
297M   kernel-firmware-20180730_7b5835f-noarch-1
335M   qt5-5.11.1-x86_64-1alien
428M   texlive-2018.180630-x86_64-2
529M   rust-1.28.0-x86_64-1
718M   llvm-6.0.1-x86_64-1
800M   kernel-source-4.14.60-noarch-1
root@darkstar:~#</code></pre></div>

<p>Another example is calculate the size of all packages toghether:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:~# ./pkgsize-meta | numfmt --from<span style="color:#f92672">=</span>si | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> | paste -sd+ | bc | numfmt --to<span style="color:#f92672">=</span>si
13G
root@darkstar:~# </code></pre></div>

<p>An installed file can grow over time, and this script will not take that into account. We
can look in the disk ourselves instead of using the size provided by the package&rsquo;s metadata file:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
PKGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/var/log/packages&#34;</span>
LOGFILE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp /tmp/pkgsize.XXXXXX<span style="color:#66d9ef">)</span>
packages<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>ls -1 <span style="color:#e6db74">${</span>PKGS<span style="color:#e6db74">}</span>/$1<span style="color:#66d9ef">)</span>

total<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">for</span> p in <span style="color:#e6db74">${</span>packages[@]<span style="color:#e6db74">}</span>; <span style="color:#66d9ef">do</span>
        files<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>cat $p | sed <span style="color:#e6db74">&#39;1,/FILE LIST/d&#39;</span> | sed <span style="color:#e6db74">&#39;s/^/\//g&#39;</span> | grep -v <span style="color:#e6db74">&#34;\/</span>$<span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
        pkgsize<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>
        <span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">${#</span>files[@]<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
                echo <span style="color:#66d9ef">$(</span>stat --printf<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%s &#34;</span> <span style="color:#e6db74">${</span>files[@]:$i:200<span style="color:#e6db74">}</span> <span style="color:#ae81ff">2</span>&gt;$LOGFILE<span style="color:#66d9ef">)</span> | sed <span style="color:#e6db74">&#39;s/ /\n/g&#39;</span>
        <span style="color:#66d9ef">done</span> | paste -sd+ | bc
        <span style="color:#66d9ef">)</span>
        echo $pkgsize $p | numfmt --to<span style="color:#f92672">=</span>si
        total<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span> total <span style="color:#f92672">+</span> pkgsize <span style="color:#66d9ef">))</span>
<span style="color:#66d9ef">done</span>
echo $total | numfmt --to<span style="color:#f92672">=</span>si</code></pre></div>

<p></p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:~# ./pkgsize kernel-source-*
784M /var/log/packages/kernel-source-4.14.60-noarch-1
784M</code></pre></div>

<p>In the examples, the kernel package reported to use 800M in the metadata file and 784M using <code>stat</code> agains all the files and adding the result.</p>

<p>With this information we may decide to delete the packages we don&rsquo;t use.</p>

<h4 id="identify-orphan-files">Identify orphan files</h4>

<p>An orphan file does not correspond to any installed package. This could mean is software or data generated during the system use. Maybe we installed or tried to install applications that polluted our system with files and didn&rsquo;t user the package management tools.</p>

<p>To decrease the number of orphan files, use <a href="https://appimage.org/">Appimage</a> or <a href="https://flatpak.org/">flatpak</a> to install software which do not have a package for Slackware. Also consider making your own packages, it is easy and allows you to control all the files on your system.</p>

<p>We can devise a script to find all orphan files and list them along with their size in Kb. Be aware this script is slow and requires a considerable amount of RAM (around 400M on our case). See the contribution below for a better approach.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
LOGFILE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp /tmp/pkgorphan.XXXXXX<span style="color:#66d9ef">)</span>

files<span style="color:#f92672">=()</span>
TMP<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp -d /tmp/orphan.XXXXXX<span style="color:#66d9ef">)</span>

cd $TMP

<span style="color:#66d9ef">for</span> p in <span style="color:#e6db74">`</span>ls -1 /var/log/packages<span style="color:#e6db74">`</span>; <span style="color:#66d9ef">do</span>
        cat /var/log/packages/$p |sed -e <span style="color:#e6db74">&#39;1,/FILE LIST/d&#39;</span> | sed <span style="color:#e6db74">&#39;s/^/\//g&#39;</span> | sed <span style="color:#e6db74">&#39;s/\/$//g&#39;</span> 
<span style="color:#66d9ef">done</span> | sort -u &gt; meta

<span style="color:#66d9ef">for</span> i in usr bin sbin lib lib64 opt srv var etc root; <span style="color:#66d9ef">do</span>
        find /$i -type f
<span style="color:#66d9ef">done</span> | sort -u &gt; disk


awk <span style="color:#e6db74">&#39;NR==FNR { A[$1] ; next } !($1 in A) { print $1 }&#39;</span> meta disk &gt; orphans

files<span style="color:#f92672">=(</span><span style="color:#66d9ef">$(</span>cat orphans<span style="color:#66d9ef">)</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>seq <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">${#</span>files[@]<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
        ls -d -s -1 <span style="color:#e6db74">${</span>files[@]:$i:200<span style="color:#e6db74">}</span> <span style="color:#ae81ff">2</span>&gt;$LOGFILE
<span style="color:#66d9ef">done</span> &gt; orphans-size</code></pre></div>

<p>A brave soul on #irc contributed another way to look for orphans, with better performance:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!bin/bash
</span><span style="color:#75715e"></span><span style="color:#75715e"># This needs bash for arrays</span>
#
<span style="color:#75715e"># Author: Jakub Jankowski &lt;shasta@slackware.pl&gt;</span>
#
 
ONLY_FSTYPES_RGXP<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;^(btrfs|ext[234]|xfs|jfs)$&#39;</span>
SKIP_PATHS<span style="color:#f92672">=(</span> <span style="color:#e6db74">&#39;/root/*&#39;</span> <span style="color:#e6db74">&#39;/home/*&#39;</span> <span style="color:#e6db74">&#39;/mnt/*&#39;</span>
             <span style="color:#e6db74">&#39;/var/run/*&#39;</span> <span style="color:#e6db74">&#39;/var/tmp/*&#39;</span> <span style="color:#e6db74">&#39;/var/spool/*&#39;</span>
             <span style="color:#e6db74">&#39;/var/log/pkgtools/*&#39;</span> <span style="color:#e6db74">&#39;/var/lib/pkgtools/*&#39;</span> <span style="color:#e6db74">&#39;/var/lib/sbopkg/*&#39;</span>
             <span style="color:#e6db74">&#39;/var/cache/lxc/*&#39;</span>
             <span style="color:#e6db74">&#39;/usr/src/linux*&#39;</span>
             <span style="color:#e6db74">&#39;/tmp/*&#39;</span> <span style="color:#f92672">)</span>
 
<span style="color:#75715e"># create temporary files</span>
FROM_PKGS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp<span style="color:#66d9ef">)</span>
FROM_FS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp<span style="color:#66d9ef">)</span>
 
set -e
 
<span style="color:#75715e"># list all files/dirs brought by packages;</span>
<span style="color:#75715e"># we are also stripping .new suffix as that&#39;s how config</span>
<span style="color:#75715e"># files come in, but they are later mv&#39;d &#34;foo.new&#34; &#34;foo&#34;</span>
<span style="color:#66d9ef">for</span> pkg in /var/log/packages/*; <span style="color:#66d9ef">do</span>
  sed -e <span style="color:#e6db74">&#39;1,/^FILE LIST:/d;
</span><span style="color:#e6db74">         /^\.\/$/d;
</span><span style="color:#e6db74">         /^install\//d;
</span><span style="color:#e6db74">         s,^,/,;
</span><span style="color:#e6db74">         s,\.new$,,;
</span><span style="color:#e6db74">         s,/$,,&#39;</span> <span style="color:#e6db74">&#34;</span>$pkg<span style="color:#e6db74">&#34;</span>
<span style="color:#66d9ef">done</span> &gt; <span style="color:#e6db74">&#34;</span>$FROM_PKGS<span style="color:#e6db74">&#34;</span>
 
<span style="color:#75715e"># find all files/directories on filesystem, but only if fs type is one of $ONLY_FSTYPES_RGXP;</span>
<span style="color:#75715e"># on&#39;t descend to other filesystems (-xdev), and ignore paths from $SKIP_PATHS</span>
declare -a EXCL<span style="color:#f92672">=(</span> <span style="color:#f92672">)</span>
<span style="color:#66d9ef">for</span> p in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SKIP_PATHS[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">do</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">${#</span>EXCL[@]<span style="color:#e6db74">}</span> -eq <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    EXCL<span style="color:#f92672">=(</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXCL[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;-path&#39;</span> <span style="color:#e6db74">&#34;</span>$p<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;-prune&#39;</span> <span style="color:#f92672">)</span>
  <span style="color:#66d9ef">else</span>
    EXCL<span style="color:#f92672">=(</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXCL[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;-o&#39;</span> <span style="color:#e6db74">&#39;-path&#39;</span> <span style="color:#e6db74">&#34;</span>$p<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;-prune&#39;</span> <span style="color:#f92672">)</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#66d9ef">done</span>
<span style="color:#f92672">[</span> <span style="color:#e6db74">${#</span>EXCL[@]<span style="color:#e6db74">}</span> -gt <span style="color:#ae81ff">0</span> <span style="color:#f92672">]</span> <span style="color:#f92672">&amp;&amp;</span> EXCL<span style="color:#f92672">=(</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXCL[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;-o&#39;</span> <span style="color:#e6db74">&#39;-print&#39;</span> <span style="color:#f92672">)</span>
 
find <span style="color:#66d9ef">$(</span>awk -v fstypes<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$ONLY_FSTYPES_RGXP<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;$3 ~ fstypes {print $2}&#39;</span> /proc/mounts<span style="color:#66d9ef">)</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  -xdev <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>EXCL[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#ae81ff">2</span>&gt;/dev/null &gt; <span style="color:#e6db74">&#34;</span>$FROM_FS<span style="color:#e6db74">&#34;</span>
 
<span style="color:#75715e"># output needs to be sorted for join(1) to work</span>
LC_ALL<span style="color:#f92672">=</span>C sort -u -o <span style="color:#e6db74">&#34;</span>$FROM_PKGS<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$FROM_PKGS<span style="color:#e6db74">&#34;</span>
LC_ALL<span style="color:#f92672">=</span>C sort -u -o <span style="color:#e6db74">&#34;</span>$FROM_FS<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$FROM_FS<span style="color:#e6db74">&#34;</span>
 
<span style="color:#75715e"># see which paths in $FROM_FS are not in $FROM_PKGS</span>
LC_ALL<span style="color:#f92672">=</span>C join -a <span style="color:#ae81ff">2</span> -v <span style="color:#ae81ff">2</span> <span style="color:#e6db74">&#34;</span>$FROM_PKGS<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$FROM_FS<span style="color:#e6db74">&#34;</span>
 
<span style="color:#75715e"># clean up other two temp files</span>
rm <span style="color:#e6db74">&#34;</span>$FROM_FS<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$FROM_PKGS<span style="color:#e6db74">&#34;</span></code></pre></div>

<p>The script will give us a list of orphans. We can compute the size they use on disk using that list.</p>

<p>We can further explore the results the script generated in the file <code>orphans-size</code>:</p>

<ul>
<li>show the top-ten orphan files by its disk usage:</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:/tmp/orphan.xvA0L1# cat orphans-size | sort -k <span style="color:#ae81ff">1</span> -n -u | tail -n <span style="color:#ae81ff">10</span> | sed <span style="color:#e6db74">&#39;s/ \//K \//&#39;</span> | numfmt --from<span style="color:#f92672">=</span>si --to<span style="color:#f92672">=</span>si
96M /var/lib/flatpak/repo/objects/05/91c08407fbaa7dccc4cbc541865d27d4714b14d51417dc658841e3cd96d489.commitmeta
105M /usr/local/cuda-9.2/lib64/libcufft_static.a
115M /usr/local/cuda-9.2/nsightee_plugins/com.nvidia.cuda.repo-1.0.0-SNAPSHOT.zip
117M /usr/local/cuda-9.2/lib64/libcusolver.so.9.2.148
124M /var/lib/flatpak/app/com.spotify.Client/x86_64/stable/0591c08407fbaa7dccc4cbc541865d27d4714b14d51417dc658841e3cd96d489/files/extra/share/spotify/libcef.so
132M /var/tmp/elvis1.ses
177M /usr/local/cuda-9.2/lib64/libnvgraph_static.a
252M /var/lib/flatpak/repo/objects/69/74b95360b298f4cfe1be4025689ea20e918b689a5110984b3ffe7d339faf45.file
252M /var/lib/flatpak/repo/objects/df/45dafc31028c33ba2b26b08342dfe4044937e54eb9a3305c1cea28b5e9dfb5.file
330M /var/cache/sbopkg/qt-everywhere-opensource-src-5.7.1.tar.xz
root@darkstar:/tmp/orphan.xvA0L1# </code></pre></div>

<ul>
<li>summary the size of an specific folder</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:/tmp/orphan.xvA0L1# cat orphans-size | grep <span style="color:#e6db74">&#34;/usr/local/cuda-9.2*&#34;</span> | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span> | sort -n -k <span style="color:#ae81ff">1</span> | paste -sd+ | bc | sed <span style="color:#e6db74">&#39;s/$/K/&#39;</span> | numfmt --from<span style="color:#f92672">=</span>si --to<span style="color:#f92672">=</span>si
<span style="color:#ae81ff">2</span>.9G
root@darkstar:/tmp/orphan.xvA0L1# </code></pre></div>

<ul>
<li>summary to the second level directory hierarchy</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@darkstar:/tmp/orphan.xvA0L1# cat orphans-size | cut -d <span style="color:#e6db74">&#39;/&#39;</span> -f <span style="color:#ae81ff">1</span>,2,3 | sort -n -k <span style="color:#ae81ff">1</span> -u | awk <span style="color:#e6db74">&#39;{size[$2]+=$1}END{for (s in size){print size[s],&#34; &#34;, s}}&#39;</span> | sort -k1 -n | sed <span style="color:#e6db74">&#39;s/ /K /&#39;</span> | numfmt --from<span style="color:#f92672">=</span>si --to<span style="color:#f92672">=</span>si | tail -n <span style="color:#ae81ff">10</span>
88M   /root/.cache
115M   /usr/share
125M   /root/NVIDIA_CUDA-9.2_Samples
138M   /var/tmp
165M   /opt/calibre
188M   /usr/lib64
515M   /var/cache
<span style="color:#ae81ff">1</span>.2G   /root/latest
<span style="color:#ae81ff">2</span>.4G   /var/lib
<span style="color:#ae81ff">2</span>.5G   /usr/local
root@darkstar:/tmp/orphan.xvA0L1#</code></pre></div>

<p>After all this work, isn&rsquo;t there an application to work this out without arcane shell commands?</p>

<h2 id="delete-unwanted-files">Delete unwanted files</h2>

<p>After the analysis we&rsquo;ve identified where the disk space is and what kind of files use them:</p>

<ul>
<li><code>/usr/local</code> contains 2.5G of unaccounted space, used by cuda, plan9ports and go installations</li>
<li><code>/var/lib</code> contains 2.4G of unaccounted space, used by pacakge tools like SlackBuilds or Flatpak.</li>
<li><code>/root</code> cotains 1.2G of unaccounted space, used by cuda and other scripts</li>
</ul>

<p>Also we identified packages we don&rsquo;t use which use a lot of disk space like <code>MariaDB</code>, <code>Rust</code>, or <code>TeX</code>.</p>

<p>With that in mind we can free up a couple of GB easily without breaking anything on the system, just deleting the folders with <code>rm</code>.</p>
    </div>
    <footer>
      <hr>
      <p>
  Published
  
  <time itemprop="datePublished" datetime="2018-08-04T08:01:21&#43;00:00">
    4 Aug, 2018
  </time>
  
    in <span itemprop="articleSection"><a href="/categories/documentation/">documentation</a></span>
  
  
    and tagged <a rel="tag" href="/tags/slackbook/">slackbook</a>
  
  using <span itemprop="wordCount">1715</span> words.
</p>

      


  <aside>
    <header>Related Content</header>
    <ul>
      
        <li><a href="/posts/slackbook/">The Slackware Book</a>
        <time datetime="4M">4 minutes</time>
      
    </ul>
  </aside>


    </footer>
  </article>
</main>
    <footer>
  
  <small class="muted">
    This page was generated by
    <a  itemprop itemtype="https://schema.org/significantLink" target="_blank" rel="external noopener" href="https://after-dark.habd.as" referrerpolicy="origin-when-cross-origin">After Dark</a>.
  </small>


  

</footer>
    
    
    
      
    
  </body>
</html>
